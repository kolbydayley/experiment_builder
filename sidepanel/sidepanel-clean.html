<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convert.com Experiment Builder</title>
    <link rel="stylesheet" href="sidepanel.css">
    <link rel="stylesheet" href="workspace-v2.css">
</head>
<body>
    <!-- Unified Workspace Interface -->
    <div class="app-v2" id="mainApp">
        <div class="unified-header">
            <div class="header-main">
                <h1>Experiment Builder</h1>
                <p class="subtitle">Describe changes, get Convert.com code</p>
            </div>
            <div class="header-actions">
                <button id="commandPaletteBtn" class="btn-icon" title="Command Palette (⌘K)">
                    ⌘K
                </button>
                <button id="settingsBtn" class="btn-icon" title="Settings">
                    ⚙️
                </button>
            </div>
        </div>

        <div class="workspace-container">
            <!-- LEFT: Adaptive Main Work Area -->
            <main class="work-area" id="workArea">
                <!-- State: Fresh Start -->
                <div class="work-state" id="freshState" data-state="fresh">
                    <div class="welcome-state">
                        <div class="state-icon">🎯</div>
                        <h2>Ready to build your experiment</h2>
                        <p>Describe the changes you want to make, and I'll generate Convert.com code automatically.</p>
                        
                        <div class="current-page" id="currentPageInfo">
                            <div class="page-status" id="pageStatus">
                                <span class="page-indicator">📄</span>
                                <span class="page-url" id="currentUrl">Click "Capture Page" to begin</span>
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <button class="btn-primary btn-large" id="captureAndStartBtn">
                                <span>📸 Capture Page & Start</span>
                                <span class="shortcut">⌘P</span>
                            </button>
                            <button class="btn-secondary" id="describeOnlyBtn">
                                Just Describe Changes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- State: Building -->
                <div class="work-state hidden" id="buildingState" data-state="building">
                    <div class="build-interface">
                        <div class="build-header">
                            <h2>💬 Describe Your Changes</h2>
                            <p>Tell me what you want to change on the page, and I'll generate the Convert.com code.</p>
                        </div>

                        <div class="page-context" id="pageContext">
                            <div class="context-item">
                                <img id="pageScreenshot" class="page-thumb" alt="Page Screenshot" />
                                <div class="context-info">
                                    <span class="context-url" id="contextUrl">Current page</span>
                                    <button class="btn-link" id="recapturePageBtn">Recapture</button>
                                </div>
                            </div>
                        </div>

                        <div class="variation-builder" id="variationBuilder">
                            <div class="primary-variation">
                                <label for="primaryDescription">What changes do you want to make?</label>
                                <textarea 
                                    id="primaryDescription" 
                                    placeholder="Example: Make the call-to-action button red and 20% larger..."
                                    rows="3"
                                ></textarea>
                                <div class="builder-tools">
                                    <button class="tool-btn" id="selectElementBtn" title="Select page element">
                                        🎯 Select Element
                                    </button>
                                    <button class="tool-btn" id="uploadDesignBtn" title="Upload design file">
                                        📁 Upload Design
                                    </button>
                                    <button class="tool-btn" id="templatesBtn" title="Browse templates">
                                        📋 Templates
                                    </button>
                                </div>
                            </div>

                            <div class="additional-variations hidden" id="additionalVariations">
                                <!-- Additional variations will be added here -->
                            </div>

                            <button class="btn-link" id="addVariationBtn">+ Add Another Variation</button>
                        </div>

                        <div class="build-actions">
                            <button class="btn-primary btn-large" id="generateBtn">
                                <span class="btn-text">🚀 Generate & Preview</span>
                                <span class="btn-loading hidden">
                                    <span class="spinner"></span>
                                    Generating...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- State: Generated Results -->
                <div class="work-state hidden" id="resultsState" data-state="results">
                    <div class="results-interface">
                        <div class="results-header">
                            <h2>✨ Generated Variations</h2>
                            <p>Review, test, and deploy your experiments.</p>
                            <div class="results-actions">
                                <button class="btn-secondary" id="editDescriptionBtn">Edit Description</button>
                                <button class="btn-secondary" id="exportBtn">Export Code</button>
                            </div>
                        </div>

                        <div class="variations-grid" id="variationsGrid">
                            <!-- Generated variations will appear here -->
                        </div>

                        <div class="preview-area" id="previewArea">
                            <div class="preview-header">
                                <h3>Live Preview</h3>
                                <div class="preview-controls">
                                    <button class="btn-small" id="testVariationBtn" disabled>
                                        🧪 Test on Page
                                    </button>
                                    <button class="btn-small" id="clearPreviewBtn" disabled>
                                        Clear Preview
                                    </button>
                                </div>
                            </div>
                            <div class="preview-content" id="previewContent">
                                <div class="preview-placeholder">
                                    <p>Select a variation to preview it on the current page</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- State: Deploy -->
                <div class="work-state hidden" id="deployState" data-state="deploy">
                    <div class="deploy-interface">
                        <div class="deploy-header">
                            <h2>🚀 Deploy to Convert.com</h2>
                            <p>Push your experiment to Convert.com or export for manual setup.</p>
                        </div>

                        <div class="deploy-options" id="deployOptions">
                            <!-- Deploy options will be populated here -->
                        </div>
                    </div>
                </div>
            </main>

            <!-- RIGHT: Live Chat & Status Panel -->
            <aside class="live-panel" id="livePanel">
                <div class="panel-header">
                    <h3>Chat & Status</h3>
                    <button class="panel-toggle" id="panelToggle" aria-label="Toggle panel">
                        ←
                    </button>
                </div>

                <!-- Unified Chat Interface -->
                <div class="chat-container">
                    <div class="chat-history" id="chatHistory">
                        <div class="chat-welcome" id="chatWelcome">
                            <div class="assistant-avatar">🤖</div>
                            <div class="chat-message">
                                <p>Hi! I'm ready to help you create Convert.com experiments. Just describe what you want to change on the current page.</p>
                                <div class="chat-suggestions">
                                    <button class="suggestion-btn" data-suggestion="Change the call-to-action button to red">Change button color to red</button>
                                    <button class="suggestion-btn" data-suggestion="Make the headline 25% larger and bold">Make headline larger</button>
                                    <button class="suggestion-btn" data-suggestion="Add a promotional banner at the top of the page">Add a banner at the top</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <form class="chat-form" id="chatForm">
                            <div class="input-container">
                                <textarea 
                                    id="chatInput" 
                                    placeholder="Describe your changes or ask questions..."
                                    rows="2"
                                ></textarea>
                                <div class="input-actions">
                                    <button type="button" class="tool-btn" id="selectElementTool" title="Select page element">
                                        🎯
                                    </button>
                                    <button type="submit" class="btn-primary" id="sendChatBtn">
                                        Send
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Live Activity Stream -->
                <div class="activity-stream" id="activityStream">
                    <div class="stream-header">
                        <h4>Activity</h4>
                        <button class="btn-link" id="clearActivityBtn">Clear</button>
                    </div>
                    <div class="stream-content" id="streamContent">
                        <div class="activity-item info">
                            <span class="activity-icon">ℹ️</span>
                            <span class="activity-text">Ready to create experiments</span>
                            <span class="activity-time">now</span>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- BOTTOM: Expandable Code Drawer -->
        <div class="code-drawer" id="codeDrawer">
            <div class="drawer-header" id="drawerHeader">
                <div class="drawer-title">
                    <h3>Generated Code</h3>
                    <span class="code-count" id="codeCount">No code generated</span>
                </div>
                <div class="drawer-actions">
                    <button class="btn-small" id="exportCodeBtn">Export</button>
                    <button class="drawer-toggle" id="drawerToggle" aria-label="Toggle code drawer">
                        ↑
                    </button>
                </div>
            </div>
            <div class="drawer-content" id="drawerContent">
                <div class="code-placeholder">
                    <p>Generate code to see it here. You can edit, copy, and export from this panel.</p>
                </div>
            </div>
        </div>

        <!-- Command Palette Overlay -->
        <div class="command-palette-overlay hidden" id="commandPaletteOverlay">
            <div class="command-palette">
                <div class="palette-search">
                    <input type="text" id="paletteSearch" placeholder="Type a command..." autocomplete="off">
                </div>
                <div class="palette-results" id="paletteResults">
                    <!-- Commands will be populated here -->
                </div>
            </div>
        </div>

        <!-- Global Notifications -->
        <div id="successDisplay" class="notification success hidden">
            <span class="icon">✓</span>
            <span class="message"></span>
        </div>
        
        <div id="errorDisplay" class="notification error hidden">
            <span class="icon">⚠</span>
            <span class="message"></span>
        </div>

        <!-- Hidden Elements for Legacy Compatibility -->
        <div class="hidden-legacy-elements" style="display: none;">
            <div id="legacyCurrentUrl"></div>
            <div id="variationsList"></div>
            <div id="chatThread"></div>
            <div id="statusLog"></div>
            <div id="resultsPanel"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../utils/feature-flags.js"></script>
    <script src="../utils/performance-monitor.js"></script>
    <script src="../utils/regression-test-suite.js"></script>
    
    <!-- Core Utilities -->
    <script src="../utils/session-manager.js"></script>
    <script src="../utils/keyboard-shortcuts.js"></script>
    <script src="../utils/prompt-assistant.js"></script>
    <script src="../utils/design-file-manager.js"></script>
    <script src="../utils/convert-smart-lists.js"></script>
    <script src="../utils/visual-qa-service.js"></script>
    <script src="../utils/code-quality-monitor.js"></script>
    <script src="../utils/chatgpt-api.js"></script>

    <!-- Workspace V2 Integration -->
    <script src="workspace-v2.js"></script>
    
    <!-- Main Application -->
    <script src="sidepanel.js"></script>
</body>
</html>