<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convert.com Experiment Builder</title>
    <link rel="stylesheet" href="sidepanel.css">
    <link rel="stylesheet" href="workspace-v2.css">
</head>
<body>
    <!-- Unified Workspace Interface -->
    <div class="app-v2" id="mainApp">
        <div class="unified-header">
            <div class="header-main">
                <h1>Experiment Builder</h1>
                <p class="subtitle">Describe changes, get Convert.com code</p>
            </div>
            <div class="header-actions">
                <button id="commandPaletteBtn" class="btn-icon" title="Command Palette (⌘K)">
                    ⌘K
                </button>
                <button id="settingsBtn" class="btn-icon" title="Settings">
                    ⚙️
                </button>
            </div>
        </div>

        <div class="workspace-container">
            <!-- LEFT: Adaptive Main Work Area -->
            <main class="work-area" id="workArea">
                <!-- State: Fresh Start -->
                <div class="work-state" id="freshState" data-state="fresh">
                    <div class="welcome-state">
                        <div class="state-icon">🎯</div>
                        <h2>Ready to build your experiment</h2>
                        <p>Describe the changes you want to make, and I'll generate Convert.com code automatically.</p>
                        
                        <div class="current-page" id="currentPageInfo">
                            <div class="page-status" id="pageStatus">
                                <span class="page-indicator">📄</span>
                                <span class="page-url" id="currentUrl">Click "Capture Page" to begin</span>
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <button class="btn-primary btn-large" id="captureAndStartBtn">
                                <span>📸 Capture Page & Start</span>
                                <span class="shortcut">⌘P</span>
                            </button>
                            <button class="btn-secondary" id="describeOnlyBtn">
                                Just Describe Changes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- State: Building -->
                <div class="work-state hidden" id="buildingState" data-state="building">
                    <div class="build-interface">
                        <div class="build-header">
                            <h2>💬 Describe Your Changes</h2>
                            <p>Tell me what you want to change on the page, and I'll generate the Convert.com code.</p>
                        </div>

                        <div class="page-context" id="pageContext">
                            <div class="context-item">
                                <img id="pageScreenshot" class="page-thumb" alt="Page Screenshot" />
                                <div class="context-info">
                                    <span class="context-url" id="contextUrl">Current page</span>
                                    <button class="btn-link" id="recapturePageBtn">Recapture</button>
                                </div>
                            </div>
                        </div>

                        <div class="variation-builder" id="variationBuilder">
                            <div class="primary-variation">
                                <label for="primaryDescription">What changes do you want to make?</label>
                                <textarea 
                                    id="primaryDescription" 
                                    placeholder="Example: Make the call-to-action button red and 20% larger..."
                                    rows="3"
                                ></textarea>
                                <div class="builder-tools">
                                    <button class="tool-btn" id="selectElementBtn" title="Select page element">
                                        🎯 Select Element
                                    </button>
                                    <button class="tool-btn" id="uploadDesignBtn" title="Upload design file">
                                        📁 Upload Design
                                    </button>
                                    <button class="tool-btn" id="templatesBtn" title="Browse templates">
                                        📋 Templates
                                    </button>
                                </div>
                            </div>

                            <div class="additional-variations hidden" id="additionalVariations">
                                <!-- Additional variations will be added here -->
                            </div>

                            <button class="btn-link" id="addVariationBtn">+ Add Another Variation</button>
                        </div>

                        <div class="build-actions">
                            <button class="btn-primary btn-large" id="generateBtn">
                                <span class="btn-text">🚀 Generate & Preview</span>
                                <span class="btn-loading hidden">
                                    <span class="spinner"></span>
                                    Generating...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- State: Generated Results -->
                <div class="work-state hidden" id="resultsState" data-state="results">
                    <div class="results-interface">
                        <div class="results-header">
                            <h2>✨ Generated Variations</h2>
                            <p>Review, test, and deploy your experiments.</p>
                            <div class="results-actions">
                                <button class="btn-secondary" id="editDescriptionBtn">Edit Description</button>
                                <button class="btn-secondary" id="exportBtn">Export Code</button>
                            </div>
                        </div>

                        <div class="variations-grid" id="variationsGrid">
                            <!-- Generated variations will appear here -->
                        </div>

                        <div class="preview-area" id="previewArea">
                            <div class="preview-header">
                                <h3>Live Preview</h3>
                                <div class="preview-controls">
                                    <button class="btn-small" id="testVariationBtn" disabled>
                                        🧪 Test on Page
                                    </button>
                                    <button class="btn-small" id="clearPreviewBtn" disabled>
                                        Clear Preview
                                    </button>
                                </div>
                            </div>
                            <div class="preview-content" id="previewContent">
                                <div class="preview-placeholder">
                                    <p>Select a variation to preview it on the current page</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- State: Deploy -->
                <div class="work-state hidden" id="deployState" data-state="deploy">
                    <div class="deploy-interface">
                        <div class="deploy-header">
                            <h2>🚀 Deploy to Convert.com</h2>
                            <p>Push your experiment to Convert.com or export for manual setup.</p>
                        </div>

                        <div class="deploy-options" id="deployOptions">
                            <!-- Deploy options will be populated here -->
                        </div>
                    </div>
                </div>
            </main>

            <!-- RIGHT: Live Chat & Status Panel -->
            <aside class="live-panel" id="livePanel">
                <div class="panel-header">
                    <h3>Chat & Status</h3>
                    <button class="panel-toggle" id="panelToggle" aria-label="Toggle panel">
                        ←
                    </button>
                </div>

                <!-- Unified Chat Interface -->
                <div class="chat-container">
                    <div class="chat-history" id="chatHistory">
                        <div class="chat-welcome" id="chatWelcome">
                            <div class="assistant-avatar">🤖</div>
                            <div class="chat-message">
                                <p>Hi! I'm ready to help you create Convert.com experiments. Just describe what you want to change on the current page.</p>
                                <div class="chat-suggestions">
                                    <button class="suggestion-btn" data-suggestion="Change the call-to-action button to red">Change button color to red</button>
                                    <button class="suggestion-btn" data-suggestion="Make the headline 25% larger and bold">Make headline larger</button>
                                    <button class="suggestion-btn" data-suggestion="Add a promotional banner at the top of the page">Add a banner at the top</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <form class="chat-form" id="chatForm">
                            <div class="input-container">
                                <textarea 
                                    id="chatInput" 
                                    placeholder="Describe your changes or ask questions..."
                                    rows="2"
                                ></textarea>
                                <div class="input-actions">
                                    <button type="button" class="tool-btn" id="selectElementTool" title="Select page element">
                                        🎯
                                    </button>
                                    <button type="submit" class="btn-primary" id="sendChatBtn">
                                        Send
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Live Activity Stream -->
                <div class="activity-stream" id="activityStream">
                    <div class="stream-header">
                        <h4>Activity</h4>
                        <button class="btn-link" id="clearActivityBtn">Clear</button>
                    </div>
                    <div class="stream-content" id="streamContent">
                        <div class="activity-item info">
                            <span class="activity-icon">ℹ️</span>
                            <span class="activity-text">Ready to create experiments</span>
                            <span class="activity-time">now</span>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- BOTTOM: Expandable Code Drawer -->
        <div class="code-drawer" id="codeDrawer">
            <div class="drawer-header" id="drawerHeader">
                <div class="drawer-title">
                    <h3>Generated Code</h3>
                    <span class="code-count" id="codeCount">No code generated</span>
                </div>
                <div class="drawer-actions">
                    <button class="btn-small" id="exportCodeBtn">Export</button>
                    <button class="drawer-toggle" id="drawerToggle" aria-label="Toggle code drawer">
                        ↑
                    </button>
                </div>
            </div>
            <div class="drawer-content" id="drawerContent">
                <div class="code-placeholder">
                    <p>Generate code to see it here. You can edit, copy, and export from this panel.</p>
                </div>
            </div>
        </div>

        <!-- Convert.com Integration Panel (Slide-out) -->
        <div class="convert-panel hidden" id="convertPanel">
            <div class="convert-header">
                <h3>Deploy to Convert.com</h3>
                <button class="btn-icon" id="closeConvertPanel">✕</button>
            </div>
            <div class="convert-content" id="convertContent">
                <!-- Convert.com integration will be loaded here -->
            </div>
        </div>

        <!-- Command Palette Overlay -->
        <div class="command-palette-overlay hidden" id="commandPaletteOverlay">
            <div class="command-palette">
                <div class="palette-search">
                    <input type="text" id="paletteSearch" placeholder="Type a command..." autocomplete="off">
                </div>
                <div class="palette-results" id="paletteResults">
                    <!-- Commands will be populated here -->
                </div>
            </div>
        </div>

            <section id="panel-code" class="panel-view" aria-labelledby="code">
                <div id="resultsPanel" class="results-panel card hidden">
                    <div class="results-header">
                        <div>
                            <h3>Generated Code</h3>
                            <p class="results-subtitle">Review or edit the source for each variation.</p>
                        </div>
                        <div class="results-actions">
                            <button id="stopIterationBtn" class="btn-danger btn-small hidden">Stop</button>
                            <button id="exportAllBtn" class="btn-small">Export</button>
                            <button id="clearResultsBtn" class="btn-link">Clear</button>
                        </div>
                    </div>

                    <div id="codeTabs" class="tabs"></div>
                    <div id="codeContent" class="code-content"></div>
                </div>
            </section>

            <section id="panel-convert" class="panel-view" aria-labelledby="convert">
                <div id="convertIntegrationSection" class="convert-container card">
                    <div class="card-header">
                        <div>
                            <h3>Convert.com Workspace</h3>
                            <p>Move between credentials, projects, and launch actions without leaving the panel.</p>
                        </div>
                    </div>

                    <div class="convert-grid">
                        <div class="convert-card">
                            <h4>1. Choose Credential</h4>
                            <p class="convert-hint">Keys stay on this device. Manage them any time in Settings.</p>
                            <select id="convertApiKeySelect" class="input">
                                <option value="">-- Select API Key --</option>
                            </select>
                            <button class="btn-link" id="manageConvertKeysBtn">Manage API Keys</button>
                        </div>

                        <div class="convert-card">
                            <h4>2. Pick Account</h4>
                            <p class="convert-hint">Accounts load after selecting credentials.</p>
                            <select id="convertAccountSelect" class="input" disabled>
                                <option value="">-- Select Account --</option>
                            </select>
                        </div>

                        <div class="convert-card">
                            <h4>3. Project &amp; Experience</h4>
                            <div class="convert-fieldset">
                                <label class="setting-label-row" for="convertProjectSelect">
                                    <span>Project</span>
                                    <button class="btn-link" id="refreshConvertProjectsBtn" disabled>Refresh</button>
                                </label>
                                <select id="convertProjectSelect" class="input" disabled>
                                            </div>

        <!-- Global Notifications -->
        <div id="successDisplay" class="notification success hidden">
            <span class="icon">✓</span>
            <span class="message"></span>
        </div>
        
        <div id="errorDisplay" class="notification error hidden">
            <span class="icon">⚠</span>
            <span class="message"></span>
        </div>

        <!-- Hidden Elements for Legacy Compatibility -->
        <div class="hidden-legacy-elements" style="display: none;">
            <div id="currentUrl"></div>
            <div id="variationsList"></div>
            <div id="chatThread"></div>
            <div id="statusLog"></div>
            <div id="resultsPanel"></div>
        </div>
                                </select>

                                <label class="setting-label-row" for="convertExperienceSelect">
                                    <span>Experience</span>
                                    <button class="btn-link" id="refreshConvertExperiencesBtn" disabled>Refresh</button>
                                </label>
                                <select id="convertExperienceSelect" class="input" disabled>
                                    <option value="">-- Select Experience --</option>
                                    <option value="__create__">Create New Experience</option>
                                </select>
                            </div>

                            <div id="convertExperienceMeta" class="convert-meta hidden">
                                <div class="convert-meta-row"><span>Status</span><span id="convertExperienceStatus">-</span></div>
                                <div class="convert-meta-row"><span>Type</span><span id="convertExperienceType">-</span></div>
                                <div class="convert-meta-row"><span>Last Updated</span><span id="convertExperienceUpdated">-</span></div>
                            </div>

                            <div id="convertCreateFields" class="convert-create hidden">
                                <div class="setting-group">
                                    <label for="convertNewExperienceName">Experience Name</label>
                                    <input type="text" id="convertNewExperienceName" class="input" placeholder="Homepage Headline Test">
                                </div>
                                <div class="setting-group">
                                    <label for="convertNewExperienceType">Experience Type</label>
                                    <select id="convertNewExperienceType" class="input">
                                        <option value="a/b">A/B Test</option>
                                        <option value="a/a">A/A Test</option>
                                        <option value="deploy">Deploy</option>
                                        <option value="split_url">Split URL</option>
                                    </select>
                                </div>
                                <div class="setting-group">
                                    <label for="convertNewExperienceUrl">Target URL</label>
                                    <input type="text" id="convertNewExperienceUrl" class="input" placeholder="https://example.com/page">
                                </div>
                                <div class="setting-row-group">
                                    <div class="setting-group">
                                        <label for="convertNewBaselineName">Baseline Name</label>
                                        <input type="text" id="convertNewBaselineName" class="input" placeholder="Original">
                                    </div>
                                    <div class="setting-group">
                                        <label for="convertNewVariationName">Variation Name</label>
                                        <input type="text" id="convertNewVariationName" class="input" placeholder="Variation 1">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="convert-card">
                            <h4>4. Sync Actions</h4>
                            <p class="convert-hint">Import existing experiences, push updates, or preview from the active tab.</p>
                            <div class="convert-actions">
                                <button id="importExperienceBtn" class="btn-secondary" disabled>Pull Experience Code</button>
                                <button id="pushExperienceBtn" class="btn-primary" disabled>Push Updates to Convert</button>
                            </div>
                            <div class="convert-actions">
                                <button id="runConvertPreviewBtn" class="btn-secondary" disabled>▶️ Run Current Variation</button>
                            </div>
                            <div id="convertStatus" class="convert-status"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <div id="errorDisplay" class="notification error hidden">
            <span class="icon">⚠️</span>
            <span class="message"></span>
            <button class="close" aria-label="Dismiss">×</button>
        </div>

        <div id="successDisplay" class="notification success hidden">
            <span class="icon">✓</span>
            <span class="message"></span>
        </div>
    </div>

    <!-- Examples Modal -->
    <div id="examplesModal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Example Instructions</h3>
                <button class="modal-close" id="closeExamplesModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="examples-grid">
                    <div class="example-section">
                        <h4>Button Changes</h4>
                        <div class="example-card">
                            <div class="example-label">Simple Color Change</div>
                            <p class="example-text">"Change CTA button to orange (#FF6B35) with white text"</p>
                        </div>
                        <div class="example-card">
                            <div class="example-label">Comprehensive Update</div>
                            <p class="example-text">"Make CTA 30% larger, change to green (#4CAF50), add white text, rounded corners (8px), shadow, and smooth hover effect"</p>
                        </div>
                    </div>

                    <div class="example-section">
                        <h4>Layout Changes</h4>
                        <div class="example-card">
                            <div class="example-label">Element Positioning</div>
                            <p class="example-text">"Move hero image from right to left side, make it 50% width, position text content on the right"</p>
                        </div>
                        <div class="example-card">
                            <div class="example-label">Spacing Improvements</div>
                            <p class="example-text">"Increase spacing between sections by 40px, add more padding inside content boxes (24px all around)"</p>
                        </div>
                    </div>

                    <div class="example-section">
                        <h4>Vague but Effective</h4>
                        <div class="example-card">
                            <div class="example-label">Trust Building</div>
                            <p class="example-text">"Make the pricing section more eye-catching and trustworthy"</p>
                        </div>
                        <div class="example-card">
                            <div class="example-label">Modernization</div>
                            <p class="example-text">"Give the page a more modern, professional look"</p>
                        </div>
    </div>

    <!-- Scripts -->
    <script src="../utils/feature-flags.js"></script>
    <script src="../utils/performance-monitor.js"></script>
    <script src="../utils/regression-test-suite.js"></script>
    
    <!-- Core Utilities -->
    <script src="../utils/session-manager.js"></script>
    <script src="../utils/keyboard-shortcuts.js"></script>
    <script src="../utils/prompt-assistant.js"></script>
    <script src="../utils/design-file-manager.js"></script>
    <script src="../utils/convert-smart-lists.js"></script>
    <script src="../utils/visual-qa-service.js"></script>
    <script src="../utils/code-quality-monitor.js"></script>

    <!-- Main Application Scripts -->
    <script src="workspace-v2.js"></script>
    <script src="sidepanel.js"></script>
</body>
</html>
